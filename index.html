<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Matcher.AI Â· (AI Ver.) ì»¬ëŸ¬ ë§¤ì¹­ (ë¬´ë“œÂ·ìŠ¤íƒ€ì¼)</title>
<style>
  :root{
    --bg:#0f1115; --card:#151924; --text:#e8ecf1; --muted:#93a0ba; --border:#212635;
    --chip:#1e2330; --ok:#66d19e; --safe:#9db2ff; --pro:#ffcf6e; --accent:#8abdff;
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--accent)}
  .wrap{max-width:1100px; margin:24px auto; padding:16px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .title{font-weight:800; font-size:22px; margin-bottom:12px; display:flex; align-items:center; justify-content:space-between}
  .panel,.section{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px}
  .btn{border:1px solid var(--border); background:#0e1119; color:#e8ecf1; padding:8px 10px; border-radius:10px; cursor:pointer; transition:background .2s}
  .btn:hover{background:var(--border)}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px}
  .card{background:#0e1119; border:1px solid var(--border); border-radius:12px; padding:12px; position:relative; cursor:pointer}
  .card[tabindex="0"]:focus-visible, .chip[tabindex="0"]:focus-visible{outline:2px solid var(--accent); outline-offset:2px}
  .swatch{width:18px; height:18px; border-radius:4px; border:1px solid #0006; display:inline-block}
  .name{font-weight:700; margin-left:8px}
  .star{position:absolute; right:10px; top:10px; font-size:16px; opacity:.9; cursor:pointer}
  .star.fav{color:#ffd76b; text-shadow:0 0 8px #0006}
  .tag{font-weight:800; font-size:14px}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{display:inline-flex; align-items:center; gap:8px; background:var(--chip); border:1px solid var(--border); padding:8px 10px; border-radius:999px; cursor:pointer; transition:background .2s}
  .chip:hover{background:var(--border)}
  .chip.active{outline:2px solid var(--accent)}
  .muted{color:var(--muted); font-size:13px}
  .sec-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:6px}
  .ok{color:var(--ok)} .safe{color:var(--safe)} .pro{color:var(--pro)}
  details.section{padding:0}
  summary{list-style:none; cursor:pointer; padding:12px; border-radius:14px; display:flex; align-items:center; justify-content:space-between}
  summary::-webkit-details-marker{display:none}
  .sum-left{display:flex; align-items:center; gap:8px}
  .chev{transition:transform .15s ease; opacity:.9}
  details[open] .chev{transform:rotate(90deg)}

  /* layout */
  .cols{display:grid; grid-template-columns: 320px 1fr; gap:12px}
  @media (max-width: 900px){ .cols{grid-template-columns:1fr} }

  /* preview */
  .preview-wrap{display:flex; gap:10px; margin-bottom:12px; align-items:stretch}
  .preview{flex:1; min-width:100px; background:var(--bg); border:1px solid var(--border); border-radius:10px; display:flex; flex-direction:column; padding:4px}
  .preview-top, .preview-bottom{flex:1; border-radius:6px; transition:background-color .3s ease}
  .preview-top{background:#444; margin-bottom:3px}
  .preview-bottom{background:#555}
  .preview-info{flex:2; display:flex; flex-direction:column; justify-content:center}
  .preview-label{font-size:13px; color:var(--muted); margin-bottom:4px}
  .preview-color-name{font-size:16px; font-weight:700}
  .small{font-size:12px}
  .mode-toggle .chip.active{outline:2px solid var(--accent)}

  /* --- AI ì…ë ¥ --- */
  #textPrompt{
    width:100%; background:var(--bg); border:1px solid var(--border); color:var(--text);
    padding:10px; border-radius:10px; margin-top:4px;
  }
  #aiBtn{
    width:100%; background:var(--accent); color:var(--bg); font-weight:700;
    font-size:15px; padding:10px; margin-top:8px; border-color:var(--accent);
  }
  #aiBtn:hover{background:#a2c4ff}
  
  /* --- AI ì¶”ì²œ ê²°ê³¼ --- */
  .chip-reco{
    width:100%; padding:10px 12px; border-radius:10px; align-items:flex-start;
    flex-direction:column; gap:6px; cursor:pointer;
  }
  .chip-reco .row{ flex-wrap:nowrap; }
  .chip-reco .reasoning{
    font-size:13px; color:var(--muted); margin:0; padding-left:26px;
    line-height:1.5; white-space:normal;
  }

  /* --- ë¡œë”© ì˜¤ë²„ë ˆì´ --- */
  #loadingOverlay{
    position:fixed; inset:0; background:#00000099; backdrop-filter:blur(4px);
    display:none; align-items:center; justify-content:center; z-index:999;
  }
  #loadingOverlay::after{
    content:''; display:block; width:40px; height:40px;
    border:4px solid var(--border); border-top-color:var(--accent);
    border-radius:50%; animation:spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>
<div id="loadingOverlay" aria-hidden="true"></div>

<div class="wrap">
  <div class="title">
    <div>Matcher.AI Â· (AI Ver.) ì»¬ëŸ¬ ë§¤ì¹­ (ë¬´ë“œÂ·ìŠ¤íƒ€ì¼)</div>
    <div class="row">
      <button class="btn" id="uxBtn" aria-label="UX ê°€ì´ë“œ">UX ê°€ì´ë“œ</button>
      <button class="btn" id="resetBtn" aria-label="ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div class="cols">
    <div class="panel">
      <div class="sec-head"><div class="tag">1) ë¶„ìœ„ê¸°(ë¬´ë“œ)</div><div id="moodHint" class="muted">-</div></div>
      <div id="moodChips" class="chips"></div>
      <div class="sec-head" style="margin-top:10px"><div class="tag">2) íŒ¨ì…˜ ìŠ¤íƒ€ì¼</div><div id="styleHint" class="muted">-</div></div>
      <div id="styleChips" class="chips"></div>
      <div class="sec-head" style="margin-top:10px"><div class="tag">3) ì¶”ì²œ ëª¨ë“œ</div><div class="muted">ì–‘ë°©í–¥</div></div>
      <div class="chips mode-toggle" id="modeChips"></div>
      
      <div class="sec-head" style="margin-top:10px"><div class="tag">4) AIì— ì§ì ‘ ìš”ì²­</div></div>
      <input id="textPrompt" type="text" placeholder="ì˜ˆ: ë°ì´íŠ¸ë£©, ë©´ì ‘ìš©, ì—¬ë¦„ ì›œí†¤ ì¹´í˜ë£©, í•™êµ ë´„ ë°ì´íŠ¸ë£©" aria-label="AI ìš”ì²­ ì…ë ¥"/>
      <button id="aiBtn" class="btn">AI ì¶”ì²œ ë°›ê¸°</button>
      
      <p class="muted small" style="margin-top:12px">ğŸ’¡ íƒœê·¸/ëª¨ë“œ/í…ìŠ¤íŠ¸ë¥¼ ì¡°í•©í•˜ì—¬ AIê°€ ì¶”ì²œì„ ìƒì„±í•©ë‹ˆë‹¤. ìƒ‰ìƒ ì¹´ë“œë¥¼ í´ë¦­í•´ë„ AI ì¶”ì²œì´ ë™ì‘í•©ë‹ˆë‹¤.</p>
    </div>

    <div class="section">
      <details id="paletteSection" class="section" open>
        <summary>
          <div class="sum-left"><span class="chev">â–¶</span><span class="tag" id="paletteTitle">ëª¨ë“  ìƒì˜ ìƒ‰</span></div>
          <div id="allCount" class="muted">0ê°œ</div>
        </summary>
        <div style="padding:12px;">
          <div class="sec-head" style="margin-top:2px;"><div class="tag">í•µì‹¬ 5</div></div>
          <div id="coreGrid" class="grid" style="margin-bottom:8px;"></div>
          <details id="moreColors" class="section" style="margin-top:8px;">
            <summary>
              <div class="sum-left"><span class="chev">â–¶</span><span class="tag">ë”ë³´ê¸°</span></div>
              <div id="moreCount" class="muted">0ê°œ</div>
            </summary>
            <div style="padding:12px 12px 0 12px;"><div id="restGrid" class="grid"></div></div>
          </details>
        </div>
      </details>

      <div id="resultSection" class="section" style="margin-top:12px;" role="region" aria-live="polite">
        <div class="sec-head"><div class="tag" id="resultTitle">ì¶”ì²œ í•˜ì˜</div><div id="recentHint" class="muted">ìµœê·¼ ì„ íƒ: -</div></div>
        <div id="resultArea"><p style="color:#93a0ba">ğŸ’¡ ìƒ‰ ì¹´ë“œë¥¼ í´ë¦­í•˜ê±°ë‚˜ AIì— ìš”ì²­í•˜ë©´ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p></div>
      </div>
    </div>
  </div>
</div>

<div id="uxModal" style="display:none; position:fixed; inset:0; background:#0008; backdrop-filter: blur(2px); align-items:center; justify-content:center;">
  <div style="width:min(760px,90vw); max-height:80vh; overflow:auto" class="panel">
    <div class="sec-head"><div class="tag">UX ê°€ì´ë“œ (AI Ver.)</div><button class="btn" id="uxClose">ë‹«ê¸°</button></div>
    <ol style="margin:0 0 6px 18px; line-height:1.6">
      <li><b>ë¬´ë“œ</b>ì™€ <b>ìŠ¤íƒ€ì¼</b>ì„ ë¨¼ì € ì„ íƒí•©ë‹ˆë‹¤.</li>
      <li>AIì—ê²Œ êµ¬ì²´ì ì¸ ìƒí™©(<b>í…ìŠ¤íŠ¸</b>)ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><b>ëª¨ë“œ</b>(ìƒì˜â†’í•˜ì˜, í•˜ì˜â†’ìƒì˜)ë¥¼ ì •í•©ë‹ˆë‹¤.</li>
      <li><b>ìƒ‰ìƒ ì¹´ë“œë¥¼ í´ë¦­</b>í•˜ê±°ë‚˜, <b>"AI ì¶”ì²œ ë°›ê¸°" ë²„íŠ¼</b>ì„ ëˆ„ë¦…ë‹ˆë‹¤.</li>
      <li>AIê°€ ì¶”ì²œ ìƒ‰ìƒê³¼ <b>"ì¶”ì²œ ì´ìœ "</b>ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜)</li>
      <li>ì¶”ì²œ ì¹©ì„ í´ë¦­í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ì— ë°˜ì˜ë˜ë©°, ë¬´ì‹ ì‚¬ ë§í¬ë„ í•¨ê»˜ ì œê³µë©ë‹ˆë‹¤.</li>
    </ol>
    <p class="muted small">â€» ë³¸ ë²„ì „ì€ ì‹¤ì œ AI APIë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³ , <b>AI ì‘ë‹µì„ ì‹œë®¬ë ˆì´ì…˜(Mock)</b>í•©ë‹ˆë‹¤.</p>
  </div>
</div>

<script>
/* ===== ê¸°ë³¸ ë°ì´í„° (ìƒ‰ìƒ) ===== */
const COLOR_HEX = {"ë²„ê±´ë””":"#7A1F2B","ë„¤ì´ë¹„":"#0F2C5C","ë¯¸ë“œ ê·¸ë ˆì´":"#8E94A3","í¬ë ˆìŠ¤íŠ¸ ê·¸ë¦°":"#2E5D4E","í™”ì´íŠ¸":"#FFFFFF","ì•„ì´ë³´ë¦¬":"#F4F0E6","í¬ë¦¼":"#F7F2E7","ë² ì´ì§€":"#D6C3A1","ì°¨ì½œ":"#2B2F39","ë¸”ë™":"#000000","ë¸Œë¼ìš´":"#6E4C3A","ëª¨ì¹´":"#7A5B48","ì¹´í‚¤(ì˜¬ë¦¬ë¸Œ)":"#6C7A3C","ì˜¬ë¦¬ë¸Œ":"#6C7A3C","ê·¸ë¦°":"#2A8A4B","ì„¸ì´ì§€ ê·¸ë¦°":"#8FA998","ë¼ì´íŠ¸ ê·¸ë ˆì´":"#D8DCE2","ê·¸ë ˆì´":"#8E94A3","ìŠ¬ë ˆì´íŠ¸ ë¸”ë£¨":"#5B6E8A","ì¤‘ì²­ ë°ë‹˜":"#3B5C92","ì—°ì²­ ë°ë‹˜":"#6F8FC5","í‘ì²­":"#2F323A","ë¼ì¼ë½":"#B59AD0","í¼í”Œ":"#6441A5","í•‘í¬":"#E7A8B3","ì½”ë„":"#FF7F6E","í…Œë¼ì½”íƒ€":"#C25A3A","ë ˆë“œ":"#E53935","ì˜¤ë Œì§€":"#F78C2F","ì˜ë¡œìš°":"#F5CF45","ë²„í„° ì˜ë¡œ":"#F6E8A7","ì†Œë¼ìƒ‰":"#9EC5E8","ë¼ì´íŠ¸ ë¸”ë£¨":"#BFD8FF","ë¯¼íŠ¸":"#ABE3D3","í‹¸(ì²­ë¡)":"#1C8073","ê·¸ë ˆì´ì§€":"#BEB7A4","ë”¥ë¸”ë£¨":"#0B3A7E","ì—°ë‘ìƒ‰":"#9ED36A","í¬ë¦¼ì§„":"#EDE8DA"};

/* ===== ë¬´ë“œ/ìŠ¤íƒ€ì¼ íŒíŠ¸ ì„¸íŠ¸ ===== */
const MOODS = [
  {id:'warm', label:'ë”°ëœ»í•œ', colors:[]}, 
  {id:'cool', label:'ì°¨ê°€ìš´', colors:[]},
  {id:'neutral', label:'ì¤‘ë¦½', colors:[]}
];
const STYLES = [
  {id:'casual', label:'ìºì£¼ì–¼', colors:[]},
  {id:'street', label:'ìŠ¤íŠ¸ë¦¿', colors:[]},
  {id:'dandy', label:'ëŒ„ë””', colors:[]},
  {id:'retro', label:'ë ˆíŠ¸ë¡œ', colors:[]}
];

/* ===== ìƒíƒœ ì €ì¥/ìœ í‹¸ ===== */
const LS = { fav:"favColors.v2", recent:"recentColor.v2", mode:"mode.v2", mood:"mood.v2", style:"style.v2" };
const STATE = { anchor:'top' }; // 'top'ì´ë©´ í•˜ì˜ê°€ ì¶”ì²œ ëŒ€ìƒ, 'bottom'ì´ë©´ ìƒì˜ê°€ ì¶”ì²œ ëŒ€ìƒ
const $ = s=>document.querySelector(s);
function gLS(k,f){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):f;}catch{return f;}}
function sLS(k,v){ try{localStorage.setItem(k,JSON.stringify(v));}catch{} }

/* ì´ë¦„/ë¦¬ìŠ¤íŠ¸ */
const NAMES = Object.keys(COLOR_HEX).sort((a,b)=>a.localeCompare(b,'ko'));
const CORE = ["ë¸”ë™","ì°¨ì½œ","ë²„ê±´ë””","ì˜¬ë¦¬ë¸Œ","í™”ì´íŠ¸"];
const REST = NAMES.filter(n=>!CORE.includes(n));

function favSet(){ return new Set(gLS(LS.fav, [])); }
function isFav(n){ return favSet().has(n); }
function toggleFav(n){ const s=favSet(); s.has(n)?s.delete(n):s.add(n); sLS(LS.fav,[...s]); renderPalette(); }

/* ===== ë³´ì•ˆ ìœ í‹¸(XSS ë°©ì§€) ===== */
function escapeHTML(s=''){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('\"','&quot;')
    .replaceAll("'",'&#39;');
}

/* ===== í…ìŠ¤íŠ¸ ì˜ë„ íŒŒì„œ ===== */
function parseIntent(raw){
  const t = raw.trim();
  const intent = { type:null, intentLabel:null, occasion:null, season:null, place:null, tone:null };
  const has = (...keys)=> keys.some(k=> t.includes(k));

  // Tone
  if(has('ì›œí†¤','ë”°ëœ»í•œí†¤','warm tone','warmtone')) intent.tone='warm';
  if(has('ì¿¨í†¤','ì°¨ê°€ìš´í†¤','cool tone','cooltone')) intent.tone='cool';

  // Occasion
  if(has('ë°ì´íŠ¸','ë°ì´íŠ¸ë£©')){ intent.type='occasion'; intent.occasion='date'; intent.intentLabel='ë°ì´íŠ¸ë£©'; }
  else if(has('ë©´ì ‘','ì¸í„´','ìì†Œì„œ')){ intent.type='occasion'; intent.occasion='interview'; intent.intentLabel='ë©´ì ‘ë£©'; }
  else if(has('ê²°í˜¼ì‹','í•˜ê°')){ intent.type='occasion'; intent.occasion='wedding'; intent.intentLabel='í•˜ê°ë£©'; }
  else if(has('ì¶œê·¼','ì˜¤í”¼ìŠ¤','ë¹„ì¦ˆë‹ˆìŠ¤')){ intent.type='occasion'; intent.occasion='office'; intent.intentLabel='ì˜¤í”¼ìŠ¤ë£©'; }
  else if(has('ì†Œê°œíŒ…')){ intent.type='occasion'; intent.occasion='date'; intent.intentLabel='ì†Œê°œíŒ…ë£©'; }
  else if(has('ì£¼ëª©','ì‹œì„ ','í¬ì¸íŠ¸','ë¬´ëŒ€','ë°œí‘œ','ìŠ¤í¬íŠ¸ë¼ì´íŠ¸')){ intent.type='occasion'; intent.occasion='spotlight'; intent.intentLabel='ì£¼ëª©ë°›ëŠ” ìë¦¬'; }

  // Season
  if(has('ë´„','spring')) intent.season='spring';
  if(has('ì—¬ë¦„','summer','íœ´ê°€','ë°”ìº‰ìŠ¤')) intent.season='summer';
  if(has('ê°€ì„','fall','autumn')) intent.season='fall';
  if(has('ê²¨ìš¸','winter')) intent.season='winter';

  // Place (í™•ì¥íŒ)
  if(has('ì¹´í˜')) intent.place='cafe';
  if(has('ì‹ë‹¹','ë ˆìŠ¤í† ë‘')) intent.place='restaurant';
  if(has('ì•¼ì™¸','ê³µì›','í•œê°•')) intent.place='outdoor';
  if(has('í•™êµ','ìº í¼ìŠ¤','êµë‚´')) intent.place='school';
  if(has('ìˆ ì§‘','ë°”','í˜¸í”„','í')) intent.place='bar';
  if(has('ë†€ì´ê³µì›','í…Œë§ˆíŒŒí¬','ë¡¯ë°ì›”ë“œ','ì—ë²„ëœë“œ')) intent.place='amusement';

  return intent;
}

/* ===== ìƒí™©ë³„ ìƒ‰ìƒ ë£°ì…‹ ===== */
function colorsForOccasion(occ, mood, style, season, tone, place){
  const LIB = {
    neutralBase:['í™”ì´íŠ¸','ì•„ì´ë³´ë¦¬','ë¼ì´íŠ¸ ê·¸ë ˆì´','ë„¤ì´ë¹„','ë¸”ë™'],
    playful:['ì†Œë¼ìƒ‰','ë¼ì´íŠ¸ ë¸”ë£¨','ë¯¼íŠ¸','ë²„í„° ì˜ë¡œ','ì½”ë„','ë¼ì¼ë½'],
    warmish:['ë² ì´ì§€','ë¸Œë¼ìš´','ëª¨ì¹´','ë²„ê±´ë””','í…Œë¼ì½”íƒ€','ë²„í„° ì˜ë¡œ'],
    coolish:['ìŠ¬ë ˆì´íŠ¸ ë¸”ë£¨','í¬ë ˆìŠ¤íŠ¸ ê·¸ë¦°','ê·¸ë ˆì´','ì°¨ì½œ','í¼í”Œ']
  };
  const pick = (...arrs)=> arrs.flat().filter((v,i,a)=>a.indexOf(v)===i);

  let perfect=[], safe=[], pro=[];

  switch(occ){
    case 'date': {
      safe = pick(LIB.neutralBase);
      perfect = pick(['ì•„ì´ë³´ë¦¬','ë² ì´ì§€','ë„¤ì´ë¹„','ë¼ì´íŠ¸ ê·¸ë ˆì´']);
      pro = pick(['ì†Œë¼ìƒ‰','ë¼ì´íŠ¸ ë¸”ë£¨','ë²„ê±´ë””','ì½”ë„','ë²„í„° ì˜ë¡œ']);
      break;
    }
    case 'interview': {
      perfect = ['ë„¤ì´ë¹„','ë¼ì´íŠ¸ ê·¸ë ˆì´'];
      safe = ['í™”ì´íŠ¸','ì°¨ì½œ','ë¸”ë™'];
      pro = ['ë²„ê±´ë””'];
      break;
    }
    case 'wedding': {
      perfect = ['ë„¤ì´ë¹„','ë² ì´ì§€','ì•„ì´ë³´ë¦¬'];
      safe = ['ë¼ì´íŠ¸ ê·¸ë ˆì´','ì°¨ì½œ'];
      pro = ['ë²„ê±´ë””','ë¼ì¼ë½'];
      break;
    }
    case 'office': {
      perfect = ['ë¼ì´íŠ¸ ê·¸ë ˆì´','ë„¤ì´ë¹„'];
      safe = ['í™”ì´íŠ¸','ë¸”ë™','ê·¸ë ˆì´ì§€'];
      pro = ['ë²„ê±´ë””','í¬ë ˆìŠ¤íŠ¸ ê·¸ë¦°'];
      break;
    }
    case 'spotlight': {
      perfect = pick(['ì•„ì´ë³´ë¦¬','ë„¤ì´ë¹„','ë²„ê±´ë””','ì½”ë„']);
      safe = pick(['ë¸”ë™','ë¼ì´íŠ¸ ê·¸ë ˆì´','ë² ì´ì§€']);
      pro = pick(['ì˜ë¡œìš°','í¼í”Œ','ë ˆë“œ','í‹¸(ì²­ë¡)']);
      break;
    }
    default: {
      perfect = ['ì•„ì´ë³´ë¦¬','ë„¤ì´ë¹„'];
      safe = ['ë¼ì´íŠ¸ ê·¸ë ˆì´','ë¸”ë™'];
      pro = ['ë² ì´ì§€','ë²„ê±´ë””'];
    }
  }

  // ë¬´ë“œ ë³´ì •
  if(mood==='warm'){ perfect = pick(perfect, ['ë² ì´ì§€']); pro = pick(pro, ['í…Œë¼ì½”íƒ€']); }
  else if(mood==='cool'){ perfect = pick(perfect, ['ìŠ¬ë ˆì´íŠ¸ ë¸”ë£¨']); pro = pick(pro, ['í¬ë ˆìŠ¤íŠ¸ ê·¸ë¦°']); }

  // ìŠ¤íƒ€ì¼ ë³´ì •
  if(style==='street') pro = pick(pro, ['ë¸”ë™','ì°¨ì½œ']);
  if(style==='dandy')  perfect = pick(perfect, ['ë„¤ì´ë¹„','ë²„ê±´ë””']);
  if(style==='retro')  pro = pick(pro, ['ë¸Œë¼ìš´','ëª¨ì¹´']);

  // ê³„ì ˆ ë³´ì •
  if(season==='spring') pro = pick(pro, ['ì†Œë¼ìƒ‰','ë¯¼íŠ¸']);
  if(season==='summer') perfect = pick(perfect, ['í™”ì´íŠ¸','ë¼ì´íŠ¸ ë¸”ë£¨']);
  if(season==='fall')   perfect = pick(perfect, ['ë² ì´ì§€','ë¸Œë¼ìš´']);
  if(season==='winter') safe = pick(safe, ['ì°¨ì½œ','ë”¥ë¸”ë£¨']);

  // í†¤ ë³´ì •
  if(tone==='warm'){ perfect = pick(perfect, ['ë² ì´ì§€','ì½”ë„','ë²„í„° ì˜ë¡œ']); pro = pick(pro, ['í…Œë¼ì½”íƒ€','ë²„ê±´ë””']); }
  if(tone==='cool'){ perfect = pick(perfect, ['ë¯¼íŠ¸','ì†Œë¼ìƒ‰','ë¼ì´íŠ¸ ë¸”ë£¨']); pro = pick(pro, ['ìŠ¬ë ˆì´íŠ¸ ë¸”ë£¨','í¼í”Œ']); }

  // ì¥ì†Œ ë³´ì •
  if(place==='school'){
    perfect = pick(perfect, ['ì—°ì²­ ë°ë‹˜','í¬ë¦¼ì§„','ì†Œë¼ìƒ‰']);
    safe    = pick(safe,    ['ë¼ì´íŠ¸ ê·¸ë ˆì´','ì•„ì´ë³´ë¦¬']);
    pro     = pick(pro,     ['ë²„í„° ì˜ë¡œ','ë¯¼íŠ¸']);
  }
  if(place==='bar'){
    perfect = pick(perfect, ['ë¸”ë™','ì°¨ì½œ','ë²„ê±´ë””','ë„¤ì´ë¹„']);
    pro     = pick(pro,     ['ë ˆë“œ','í¼í”Œ','í‹¸(ì²­ë¡)']);
  }
  if(place==='amusement'){
    perfect = pick(perfect, ['í™”ì´íŠ¸','ë¼ì´íŠ¸ ë¸”ë£¨','ì—°ì²­ ë°ë‹˜']);
    pro     = pick(pro,     ['ì˜ë¡œìš°','ì½”ë„','ë¯¼íŠ¸']);
  }

  const mkReason = (n)=>{
    const base = {
      'ì•„ì´ë³´ë¦¬':'ë¶€ë“œëŸ½ê³  ë°ì€ ì¸ìƒì„ ì¤ë‹ˆë‹¤.',
      'ë² ì´ì§€':'ë”°ëœ»í•˜ê³  ì•ˆì •ì ì¸ ë¬´ë“œì…ë‹ˆë‹¤.',
      'ë„¤ì´ë¹„':'ì‹ ë¢°ê°ê³¼ ë‹¨ì •í•¨ì„ ì œê³µí•©ë‹ˆë‹¤.',
      'ë¼ì´íŠ¸ ê·¸ë ˆì´':'ì„¸ë ¨ë˜ê³  ë„ì‹œì ì¸ ì¸ìƒì…ë‹ˆë‹¤.',
      'ì†Œë¼ìƒ‰':'ì²­ëŸ‰í•œ í¬ì¸íŠ¸ë¡œ ì‚°ëœ»í•©ë‹ˆë‹¤.',
      'ë¼ì´íŠ¸ ë¸”ë£¨':'í¸ì•ˆí•˜ê³  ì  í‹€í•œ ëŠë‚Œì…ë‹ˆë‹¤.',
      'ë²„ê±´ë””':'ì„¸ë ¨ëœ í¬ì¸íŠ¸ ì»¬ëŸ¬ì…ë‹ˆë‹¤.',
      'ì½”ë„':'í˜ˆìƒ‰ì„ ì‚´ë ¤ ì‚¬ì§„/ì‹¤ë¬¼ ëª¨ë‘ ì¢‹ìŠµë‹ˆë‹¤.',
      'ë²„í„° ì˜ë¡œ':'ë¶€ë“œëŸ¬ìš´ í™”ì‚¬í•¨ì„ ë”í•©ë‹ˆë‹¤.',
      'í™”ì´íŠ¸':'ê¹¨ë—í•˜ê³  ì‹¤íŒ¨ ì—†ëŠ” ê¸°ë³¸ì…ë‹ˆë‹¤.',
      'ë¸”ë™':'ì‹œí¬í•˜ê³  ìŠ¬ë¦¼í•´ ë³´ì…ë‹ˆë‹¤.',
      'ì°¨ì½œ':'ì•ˆì •ì ì¸ ë‹¤í¬ í†¤ì…ë‹ˆë‹¤.',
      'í¬ë ˆìŠ¤íŠ¸ ê·¸ë¦°':'ì°¨ë¶„í•˜ê³  ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ìƒ‰ê°ì…ë‹ˆë‹¤.',
      'ìŠ¬ë ˆì´íŠ¸ ë¸”ë£¨':'ì°¨ê°‘ê³  ì„¸ë ¨ëœ í†¤ì…ë‹ˆë‹¤.',
      'ë¸Œë¼ìš´':'ë ˆíŠ¸ë¡œ ê°ì„±ê³¼ ë”°ëœ»í•¨ì„ ì¤ë‹ˆë‹¤.',
      'ëª¨ì¹´':'ë¶€ë“œëŸ½ê³  í¬ê·¼í•œ ë¬´ë“œì…ë‹ˆë‹¤.',
      'ê·¸ë ˆì´ì§€':'ì¤‘ë¦½ í†¤ìœ¼ë¡œ ì–´ë””ë“  ì–´ìš¸ë¦½ë‹ˆë‹¤.',
      'ë”¥ë¸”ë£¨':'ê²¨ìš¸ ì‹œì¦Œì— ì•ˆì •ì ì¸ ë‹¤í¬ ë¸”ë£¨.',
      'ì—°ì²­ ë°ë‹˜':'ìºì£¼ì–¼í•˜ê³  ë°ì€ ë¬´ë“œì˜ ë°ë‹˜ í†¤.',
      'í¬ë¦¼ì§„':'ë¬´ë‚œí•˜ê³  ë”°ëœ»í•œ ë¼ì´íŠ¸ íŒ¬ì¸  í†¤.',
      'ì˜ë¡œìš°':'í™œê¸°ì™€ ì¡´ì¬ê°ì„ ë†’ì—¬ì¤ë‹ˆë‹¤.',
      'ë¯¼íŠ¸':'ìƒí¼í•œ ì²­ëŸ‰ í¬ì¸íŠ¸ì…ë‹ˆë‹¤.',
      'í¼í”Œ':'ê°œì„± ìˆê³  ê³ ê¸‰ìŠ¤ëŸ¬ìš´ í¬ì¸íŠ¸.'
    };
    return base[n] || 'ì¡°í™”ë¡œìš´ í†¤ ë°¸ëŸ°ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.';
  };

  return {
    perfect: perfect.filter(c=>COLOR_HEX[c]).map(c=>({name:c, reasoning: mkReason(c)})),
    safe:    safe.filter(c=>COLOR_HEX[c]).map(c=>({name:c, reasoning: mkReason(c)})),
    pro:     pro.filter(c=>COLOR_HEX[c]).map(c=>({name:c, reasoning: mkReason(c)})),
  };
}

/* ===== ë¡œë”© ì˜¤ë²„ë ˆì´ ===== */
function showLoading(show) { $('#loadingOverlay').style.display = show ? 'flex' : 'none'; }

/* ===== AI ì¶”ì²œ(Mock) ===== */
function mockAIApiCall(request) {
  const { top, bottom, text, mood, style, intent } = request;
  if(intent?.type==='occasion'){
    return colorsForOccasion(intent.occasion, mood, style, intent.season, intent.tone, intent.place);
  }

  if (text && !top && !bottom) {
    if (text.includes('ì²­ë°”ì§€') || text.includes('ë°ë‹˜')) {
      return {
        perfect: [{ name: 'í™”ì´íŠ¸', reasoning: 'ì²­ë°”ì§€ì™€ í™”ì´íŠ¸ëŠ” ì‹œëŒ€ë¥¼ ì´ˆì›”í•˜ëŠ” ì¡°í•©ì…ë‹ˆë‹¤. ìºì£¼ì–¼ ë¬´ë“œì— ì™„ë²½í•©ë‹ˆë‹¤.' }],
        safe: [{ name: 'ê·¸ë ˆì´', reasoning: 'ì–´ë–¤ ì²­ë°”ì§€ í†¤ê³¼ë„ ë¬´ë‚œí•˜ê²Œ ì–´ìš¸ë¦½ë‹ˆë‹¤.' }],
        pro: [{ name: 'ë²„ê±´ë””', reasoning: 'ë°ë‹˜ì˜ íŒŒë€ìƒ‰ê³¼ ëŒ€ë¹„ë˜ì–´ ê°œì„±ì„ í‘œí˜„í•©ë‹ˆë‹¤.' }]
      };
    }
    return {
      perfect: [{ name: 'ì•„ì´ë³´ë¦¬', reasoning: 'ìš”ì²­ê³¼ ê°€ì¥ ì˜ ì–´ìš¸ë¦¬ëŠ” ì•„ì´ë³´ë¦¬ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.' }],
      safe: [{ name: 'ë¼ì´íŠ¸ ê·¸ë ˆì´', reasoning: 'ê°€ì¥ ë¬´ë‚œí•œ ì„ íƒì§€ì…ë‹ˆë‹¤.' }],
      pro: [{ name: 'ë¸”ë™', reasoning: 'ì‹œí¬í•˜ê²Œ ë§ˆë¬´ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }]
    };
  }
  if (top === 'ë²„ê±´ë””') {
    let reasoning_ivory = 'ë²„ê±´ë””ì˜ ê¹Šì€ ìƒ‰ê°ê³¼ ì•„ì´ë³´ë¦¬ì˜ ë¶€ë“œëŸ¬ì›€ì´ ë§Œë‚˜ í´ë˜ì‹í•˜ê³  ë”°ëœ»í•œ ë£©ì„ ì™„ì„±í•©ë‹ˆë‹¤.';
    if (mood === 'warm') reasoning_ivory += ' (ë”°ëœ»í•œ ë¬´ë“œ ê°€ì‚°ì )';
    if (style === 'dandy') reasoning_ivory += ' (ëŒ„ë”” ìŠ¤íƒ€ì¼ ê°€ì‚°ì )';
    return {
      perfect: [
        { name: 'ì•„ì´ë³´ë¦¬', reasoning: reasoning_ivory },
        { name: 'ë„¤ì´ë¹„', reasoning: 'ì–´ë‘ìš´ ê³„ì—´ì˜ ì¡°í•©ìœ¼ë¡œ ì•ˆì •ê°ê³¼ ì‹ ë¢°ê°ì„ ì¤ë‹ˆë‹¤. ë¹„ì¦ˆë‹ˆìŠ¤ ìºì£¼ì–¼ì— ì í•©.' }
      ],
      safe: [ { name: 'ë¸”ë™', reasoning: 'ì•ˆì „í•˜ì§€ë§Œ, ì „ì²´ê°€ ì–´ë‘ì›Œì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }, { name: 'ë¼ì´íŠ¸ ê·¸ë ˆì´', reasoning: 'ë²„ê±´ë””ë¥¼ ë‹ë³´ì´ê²Œ í•©ë‹ˆë‹¤.' } ],
      pro: [ { name: 'ì¹´í‚¤(ì˜¬ë¦¬ë¸Œ)', reasoning: 'í”ì¹˜ ì•Šì€ ì¡°í•©ìœ¼ë¡œ ê°œì„±ì„ ë“œëŸ¬ëƒ…ë‹ˆë‹¤.' }, { name: 'ë² ì´ì§€', reasoning: 'í•œ í†¤ ë‹¤ìš´ëœ ì°¨ë¶„í•¨.' } ]
    };
  }
  if (bottom === 'ë„¤ì´ë¹„') {
     return {
      perfect: [ { name: 'í™”ì´íŠ¸', reasoning: 'ë„¤ì´ë¹„Ã—í™”ì´íŠ¸ëŠ” ì‹¤íŒ¨ ì—†ëŠ” ë§ˆë¦°/ëŒ„ë”” ì¡°í•©.' }, { name: 'ì•„ì´ë³´ë¦¬', reasoning: 'í™”ì´íŠ¸ë³´ë‹¤ ë¶€ë“œëŸ½ìŠµë‹ˆë‹¤.' } ],
      safe: [ { name: 'ë¼ì´íŠ¸ ê·¸ë ˆì´', reasoning: 'ë„ì‹œì ì´ê³  ì„¸ë ¨.' }, { name: 'ë„¤ì´ë¹„', reasoning: 'í†¤ì˜¨í†¤ ì•ˆì •ê°.' } ],
      pro: [ { name: 'ì˜ë¡œìš°', reasoning: 'ë³´ìƒ‰ ëŒ€ë¹„ë¡œ í™œê¸°.' }, { name: 'ë²„ê±´ë””', reasoning: 'ì‹ ë¢°ì™€ ê°œì„±ì„ ë™ì‹œì—.' } ]
    };
  }
  if (bottom === 'ì¤‘ì²­ ë°ë‹˜') {
     return {
      perfect: [ { name: 'í™”ì´íŠ¸', reasoning: 'ë°ë‹˜Ã—í™”ì´íŠ¸ëŠ” í´ë˜ì‹.' }, { name: 'ì•„ì´ë³´ë¦¬', reasoning: 'ë¶€ë“œëŸ¬ìš´ ìºì£¼ì–¼.' } ],
      safe: [ { name: 'ë¼ì´íŠ¸ ê·¸ë ˆì´', reasoning: 'í†¤ì˜¨í†¤ ë¬´ë‚œ.' }, { name: 'ë¸”ë™', reasoning: 'ì‹œí¬ ìŠ¤íŠ¸ë¦¿.' } ],
      pro: [ { name: 'ë²„ê±´ë””', reasoning: 'íŒŒë‘ ëŒ€ë¹„ í¬ì¸íŠ¸.' } ]
    };
  }
  return {
    perfect: [
      { name: 'ì•„ì´ë³´ë¦¬', reasoning: 'ë°¸ëŸ°ìŠ¤ê°€ ì¢‹ì€ ì¡°í•©ì…ë‹ˆë‹¤.' },
      { name: 'ë„¤ì´ë¹„', reasoning: 'ì•ˆì •ì ì¸ ëŒ€ë¹„ë¥¼ ì œê³µí•©ë‹ˆë‹¤.' }
    ],
    safe: [ { name: 'ë¼ì´íŠ¸ ê·¸ë ˆì´', reasoning: 'ë¬´ë‚œí•œ ì„ íƒ.' }, { name: 'ë¸”ë™', reasoning: 'ì•ˆì „í•œ ì„ íƒ.' } ],
    pro: [ { name: 'ì¹´í‚¤(ì˜¬ë¦¬ë¸Œ)', reasoning: 'ê°œì„±ì„ í‘œí˜„í•˜ê¸° ì¢‹ìŠµë‹ˆë‹¤.' } ]
  };
}

/* ===== ì¶”ì²œ ë Œë”ë§ ===== */
function createRecoChipNode(item) {
  const wrap = document.createElement('div');
  wrap.className = 'chip chip-reco';
  wrap.dataset.color = item.name;

  const row = document.createElement('div');
  row.className = 'row';

  const sw = document.createElement('span');
  sw.className = 'swatch';
  sw.style.background = COLOR_HEX[item.name] || '#9aa3b2';

  const nm = document.createElement('span');
  nm.className = 'name';
  nm.textContent = item.name;

  const p = document.createElement('p');
  p.className = 'reasoning';
  p.textContent = item.reasoning || '';

  row.append(sw, nm);
  wrap.append(row, p);
  return wrap;
}

function createSectionWithAI(label, cls, items) {
  if (!items || !items.length) return null;
  const panel = document.createElement('div');
  panel.className = 'panel';

  const head = document.createElement('div');
  head.className = 'sec-head';

  const tag = document.createElement('div');
  tag.className = `tag ${cls}`;
  tag.textContent = label;

  const count = document.createElement('div');
  count.className = 'muted';
  count.textContent = `${items.length}ê°œ`;

  head.append(tag, count);

  const list = document.createElement('div');
  list.className = 'chips';
  list.style.flexDirection = 'column';

  items.forEach(it => list.append(createRecoChipNode(it)));
  panel.append(head, list);
  return panel;
}

function renderAIResult(request, aiResponse) {
  const { top: reqTop, bottom: reqBottom, text, intent } = request;
  const { perfect, safe, pro } = aiResponse;
  const allItems = [...(perfect||[]), ...(safe||[]), ...(pro||[])];
  const names = allItems.map(i=>i.name);
  const first = names[0];
  const second = names.find(n=>n!==first);

  const mode = current('mode') || 'top2bottom';

  let topName, bottomName, topHex, bottomHex;

  if (intent?.type==='occasion' && !reqTop && !reqBottom) {
    const anchor = first || 'ì•„ì´ë³´ë¦¬';
    const counter = second || (anchor==='ì•„ì´ë³´ë¦¬' ? 'ë„¤ì´ë¹„' : 'ë¼ì´íŠ¸ ê·¸ë ˆì´');
    if (mode==='top2bottom') {
      topName = anchor;
      bottomName = counter;
      STATE.anchor = 'top';
    } else {
      topName = counter;
      bottomName = anchor;
      STATE.anchor = 'bottom';
    }
  } else if (reqTop) {
    topName = reqTop;
    bottomName = first || 'ì¶”ì²œ ì—†ìŒ';
    STATE.anchor = 'top';
  } else if (reqBottom) {
    topName = first || 'ì¶”ì²œ ì—†ìŒ';
    bottomName = reqBottom;
    STATE.anchor = 'bottom';
  } else {
    topName = first || 'ì•„ì´ë³´ë¦¬';
    bottomName = second || 'ë¼ì´íŠ¸ ê·¸ë ˆì´';
    STATE.anchor = (mode==='top2bottom') ? 'top' : 'bottom';
  }

  topHex = COLOR_HEX[topName] || '#444';
  bottomHex = COLOR_HEX[bottomName] || '#555';

  const area = $('#resultArea');
  area.innerHTML = '';

  const previewWrap = document.createElement('div');
  previewWrap.className = 'preview-wrap';
  const preview = document.createElement('div');
  preview.className = 'preview';
  const pt = document.createElement('div'); pt.id='previewTop'; pt.className='preview-top'; pt.style.background = topHex;
  const pb = document.createElement('div'); pb.id='previewBottom'; pb.className='preview-bottom'; pb.style.background = bottomHex;
  preview.append(pt,pb);

  const info = document.createElement('div'); info.className='preview-info';
  const l1 = document.createElement('div'); l1.className='preview-label'; l1.textContent='ìƒì˜';
  const tcn = document.createElement('div'); tcn.id='topColorName'; tcn.className='preview-color-name'; tcn.textContent = topName;
  const l2 = document.createElement('div'); l2.className='preview-label'; l2.style.marginTop='8px'; l2.textContent='í•˜ì˜';
  const bcn = document.createElement('div'); bcn.id='bottomColorName'; bcn.className='preview-color-name'; bcn.textContent = bottomName;
  info.append(l1,tcn,l2,bcn);

  previewWrap.append(preview, info);
  area.append(previewWrap);

  const grid = document.createElement('div'); grid.id='recoGrid'; grid.className='grid';
  const sec1 = createSectionWithAI('ì°°ë–¡','ok', perfect);
  const sec2 = createSectionWithAI('ë¬´ë‚œ','safe', safe);
  const sec3 = createSectionWithAI('ê³ ìˆ˜','pro', pro);
  [sec1,sec2,sec3].forEach(s=>{ if(s) grid.append(s); });
  area.append(grid);

  const topWrap = document.createElement('div'); topWrap.className='panel'; topWrap.id='musinsaTopWrap'; topWrap.style.marginTop='12px'; topWrap.style.display='none';
  topWrap.innerHTML = `<div class="sec-head"><div class="tag">ë¬´ì‹ ì‚¬ ë§í¬</div><div class="muted">ìƒì˜</div></div><p style="margin:2px 0 0 0; padding:0 6px 6px 6px;"><a id="musinsaTopLink" href="#" target="_blank" rel="noopener" style="text-decoration:underline;">-</a></p>`;
  const bottomWrap = document.createElement('div'); bottomWrap.className='panel'; bottomWrap.id='musinsaBottomWrap'; bottomWrap.style.marginTop='8px'; bottomWrap.style.display='none';
  bottomWrap.innerHTML = `<div class="sec-head"><div class="tag">ë¬´ì‹ ì‚¬ ë§í¬</div><div class="muted">í•˜ì˜</div></div><p style="margin:2px 0 0 0; padding:0 6px 6px 6px;"><a id="musinsaBottomLink" href="#" target="_blank" rel="noopener" style="text-decoration:underline;">-</a></p>`;
  area.append(topWrap, bottomWrap);

  updateMusinsaLink('top', COLOR_HEX[topName] ? topName : null);
  updateMusinsaLink('bottom', COLOR_HEX[bottomName] ? bottomName : null);
}

/* ===== UI ë¹Œë”© ===== */
function chip(label, id, group){
  const el = document.createElement('div');
  el.className = 'chip'; el.dataset.id = id; el.dataset.group = group; el.textContent = label;
  el.setAttribute('role','button'); el.tabIndex=0;
  el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); el.click(); } });
  return el;
}

function buildChips(){
  const moodWrap = $('#moodChips'); moodWrap.innerHTML='';
  MOODS.forEach(m=> moodWrap.appendChild(chip(m.label, m.id, 'mood')));
  const styleWrap = $('#styleChips'); styleWrap.innerHTML='';
  STYLES.forEach(s=> styleWrap.appendChild(chip(s.label, s.id, 'style')));
  const modeWrap = $('#modeChips'); modeWrap.innerHTML='';
  [ {id:'top2bottom', label:'ìƒì˜ â†’ í•˜ì˜'}, {id:'bottom2top', label:'í•˜ì˜ â†’ ìƒì˜'} ]
    .forEach(m=> modeWrap.appendChild(chip(m.label, m.id, 'mode')));

  const savedMood = gLS(LS.mood, 'neutral'); activateChip('mood', savedMood);
  const savedStyle = gLS(LS.style, null); if(savedStyle) activateChip('style', savedStyle);
  const savedMode = gLS(LS.mode, 'top2bottom'); activateChip('mode', savedMode);
  updateHints();
}

function activateChip(group, id){
  document.querySelectorAll(`.chip[data-group="${group}"]`).forEach(c=>{
    const active = c.dataset.id===id;
    c.classList.toggle('active', active);
  });
  if(group==='mood') sLS(LS.mood, id);
  if(group==='style') sLS(LS.style, id);
  if(group==='mode') { sLS(LS.mode, id); updateModeTitlesAndPalette(); }
}

function current(group){
  const act = document.querySelector(`.chip[data-group="${group}"].active`);
  return act? act.dataset.id : (group==='mood'?'neutral':null);
}

function updateHints(){
  const m = current('mood'); const s = current('style');
  $('#moodHint').textContent = m? MOODS.find(x=>x.id===m).label : '-';
  $('#styleHint').textContent = s? STYLES.find(x=>x.id===s).label : '-';
}

function makeCard(name){
  const card = document.createElement('div');
  card.className = 'card'; card.dataset.name = name; card.tabIndex=0; card.setAttribute('role','button'); card.setAttribute('aria-label', `${name} ì„ íƒ`);
  card.innerHTML = `
    <span class="star ${isFav(name)?'fav':''}">${isFav(name)?'â˜…':'â˜†'}</span>
    <div class="row">
      <span class="swatch" style="background:${COLOR_HEX[name]||'#9aa3b2'}" title="${name}"></span>
      <span class="name">${name}</span>
    </div>`;
  card.querySelector('.star').addEventListener('click', (e) => { e.stopPropagation(); toggleFav(name); });
  card.addEventListener('click', () => onColorCardClick(name)); 
  card.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); onColorCardClick(name); } });
  return card;
}

function renderPalette(){
  const coreGrid = $('#coreGrid'); coreGrid.innerHTML = ''; CORE.forEach(n => coreGrid.appendChild(makeCard(n)));
  const restGrid = $('#restGrid'); restGrid.innerHTML = ''; REST.forEach(n => restGrid.appendChild(makeCard(n)));
  $('#moreCount').textContent = `${REST.length}ê°œ`; $('#allCount').textContent = `ì´ ${NAMES.length}ê°œ`;
}

function updateModeTitlesAndPalette(){
  const mode = current('mode')||'top2bottom';
  const isTop = mode==='top2bottom';
  $('#paletteTitle').textContent = isTop ? 'ëª¨ë“  ìƒì˜ ìƒ‰' : 'ëª¨ë“  í•˜ì˜ ìƒ‰';
  $('#resultTitle').textContent  = isTop ? 'ì¶”ì²œ í•˜ì˜'   : 'ì¶”ì²œ ìƒì˜';
  renderPalette();
}

/* ë§í¬ */
function q(s){ return encodeURIComponent(String(s||'').replace(/\\s+/g,' ').trim()); }
function updateMusinsaLink(which, colorName){
  const wrap = document.getElementById(which==='top' ? 'musinsaTopWrap' : 'musinsaBottomWrap');
  const el = document.getElementById(which==='top' ? 'musinsaTopLink' : 'musinsaBottomLink');
  if(!wrap||!el) return;
  if(!colorName){ wrap.style.display='none'; return; }
  wrap.style.display='block';
  const query = which==='top' ? `${colorName} ìƒì˜` : `${colorName} ë°”ì§€`;
  const url = `https://www.musinsa.com/search/musinsa?q=${q(query)}`;
  el.textContent = `â€˜${colorName}â€™ ìƒ‰ ${which==='top'?'ìƒì˜':'í•˜ì˜'} ê²€ìƒ‰í•˜ê¸°`;
  el.href = url;
}

/* ===== ì´ë²¤íŠ¸: ì¶”ì²œ ì‹¤í–‰ ===== */
function getAndRenderAIRecommendation(request) {
  showLoading(true);
  setTimeout(()=>{
    try{
      const aiResponse = mockAIApiCall(request);
      renderAIResult(request, aiResponse);
    }catch(err){
      console.error('AI ì¶”ì²œ ì‹¤íŒ¨:', err);
      $('#resultArea').innerHTML = `<p style="color:var(--pro)">AI ì¶”ì²œì„ ë°›ì•„ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
    }finally{
      showLoading(false);
    }
  }, 800);
}

function onColorCardClick(name) {
  const mode = current('mode') || 'top2bottom';
  const mood = current('mood');
  const style = current('style');
  const text = $('#textPrompt').value;
  sLS(LS.recent, name); updateRecent();
  let request = { mood, style, text };
  if (mode === 'top2bottom') request.top = name; else request.bottom = name;
  getAndRenderAIRecommendation(request);
}

// í…ìŠ¤íŠ¸ ì…ë ¥ ì²˜ë¦¬(ìƒí™© ì¸ì‹ + ìƒ‰ìƒ í‚¤ì›Œë“œ ë§¤í•‘)
function normalizeTextToColorOrIntent(txt){
  const intent = parseIntent(txt);
  if(intent.type || intent.season || intent.place || intent.tone) return { intent };
  const t = txt.trim();
  const map = [
    [/ì²­ë°”ì§€|ë°ë‹˜/, 'ì¤‘ì²­ ë°ë‹˜'],
    [/í° ?ì…”ì¸ |í™”ì´íŠ¸/, 'í™”ì´íŠ¸'],
    [/ê²€ì • ?ìŠ¬ë™ìŠ¤|ë¸”ë™/, 'ë¸”ë™'],
  ];
  for(const [re,val] of map){ if(re.test(t)) return { color: val }; }
  return { text: t };
}

function onAIButtonClick() {
  const mode = current('mode') || 'top2bottom';
  const mood = current('mood');
  const style = current('style');
  const raw = $('#textPrompt').value;
  if (!raw.trim()) { alert('AIì—ê²Œ ìš”ì²­í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: ë°ì´íŠ¸ë£©)'); return; }

  const parsed = normalizeTextToColorOrIntent(raw);
  let request = { mood, style };

  if(parsed.intent){
    request.text = raw.trim();
    request.intent = parsed.intent;
    sLS(LS.recent, parsed.intent.intentLabel || 'ìƒí™©');
    $('#resultTitle').textContent = (mode==='top2bottom') ? 'ì¶”ì²œ í•˜ì˜' : 'ì¶”ì²œ ìƒì˜';
  } else if(parsed.color){
    if (mode === 'bottom2top') { request.bottom = parsed.color; $('#resultTitle').textContent = 'AI ì¶”ì²œ (ìƒì˜)'; }
    else { request.top = parsed.color; $('#resultTitle').textContent = 'AI ì¶”ì²œ (í•˜ì˜)'; }
    request.text = raw.trim();
    sLS(LS.recent, parsed.color);
  } else {
    request.text = raw.trim();
    sLS(LS.recent, raw.trim());
    $('#resultTitle').textContent = (mode==='top2bottom') ? 'ì¶”ì²œ í•˜ì˜' : 'ì¶”ì²œ ìƒì˜';
  }
  updateRecent();
  getAndRenderAIRecommendation(request);
}

function updateRecent(){ const r = gLS(LS.recent, null); $('#recentHint').textContent = 'ìµœê·¼ ì„ íƒ: ' + (r || '-'); }

/* ì´ˆê¸°í™”/ì´ë²¤íŠ¸ */
document.addEventListener('DOMContentLoaded', () => {
  buildChips(); updateModeTitlesAndPalette(); renderPalette(); updateRecent();
  $('#aiBtn').addEventListener('click', onAIButtonClick);

  // ì¶”ì²œ ì¹© í´ë¦­ â†’ ì•µì»¤ ë°˜ëŒ€í¸ë§Œ ê°±ì‹ 
  $('#resultArea').addEventListener('click', (e) => {
    const chip = e.target.closest('.chip-reco'); if (!chip) return;
    const colorName = chip.dataset.color; if (!colorName) return;

    const targetSide = (STATE.anchor === 'top') ? 'bottom' : 'top';
    if (targetSide === 'bottom') {
      const pb = document.getElementById('previewBottom'); if (pb) pb.style.backgroundColor = COLOR_HEX[colorName] || '#555';
      const bcn = document.getElementById('bottomColorName'); if (bcn) bcn.textContent = colorName;
      updateMusinsaLink('bottom', colorName);
    } else {
      const pt = document.getElementById('previewTop'); if (pt) pt.style.backgroundColor = COLOR_HEX[colorName] || '#555';
      const tcn = document.getElementById('topColorName'); if (tcn) tcn.textContent = colorName;
      updateMusinsaLink('top', colorName);
    }
  });

  // chip interactions
  document.body.addEventListener('click', (e)=>{
    const c = e.target.closest('.chip'); if(!c) return;
    const group = c.dataset.group; if(!group) return;
    const id = c.dataset.id; 
    if (group === 'mood' || group === 'style' || group === 'mode') {
      activateChip(group, id); 
      updateHints();
    }
  });

  // reset
  $('#resetBtn').addEventListener('click', ()=>{
    localStorage.clear(); buildChips(); updateModeTitlesAndPalette(); renderPalette();
    $('#resultArea').innerHTML = '<p style="color:#93a0ba">ğŸ’¡ ìƒ‰ ì¹´ë“œë¥¼ í´ë¦­í•˜ê±°ë‚˜ AIì— ìš”ì²­í•˜ë©´ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
    $('#textPrompt').value = '';
    updateRecent();
  });

  // UX modal
  const modal = $('#uxModal');
  $('#uxBtn').addEventListener('click', ()=>{ modal.style.display='flex';});
  $('#uxClose').addEventListener('click', ()=>{ modal.style.display='none';});
  modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.style.display='none'; });
});
</script>
</body>
</html>
